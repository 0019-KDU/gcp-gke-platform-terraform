# ============================================================================
# Terraform Drift Detection - Scheduled checks for infrastructure drift
# ============================================================================
name: "Terraform Drift Detection"

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to check"
        required: true
        type: choice
        options:
          - all
          - dev
          - staging
          - prod

env:
  TF_VERSION: "1.7.0"

jobs:
  # ============================================================================
  # Drift Detection Matrix
  # ============================================================================
  drift-detection:
    name: "Drift Check - ${{ matrix.environment }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: [dev, staging, prod]
    steps:
      - name: Check if should run
        id: should-run
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.environment }}" == "all" ] || [ "${{ github.event.inputs.environment }}" == "${{ matrix.environment }}" ]; then
              echo "run=true" >> $GITHUB_OUTPUT
            else
              echo "run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "run=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout Code
        if: steps.should-run.outputs.run == 'true'
        uses: actions/checkout@v4

      - name: Setup Terraform
        if: steps.should-run.outputs.run == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        if: steps.should-run.outputs.run == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        if: steps.should-run.outputs.run == 'true'
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="prefix=gke-platform/${{ matrix.environment }}"

      - name: Terraform Plan (Drift Detection)
        if: steps.should-run.outputs.run == 'true'
        id: plan
        run: |
          terraform plan \
            -detailed-exitcode \
            -no-color \
            -input=false \
            2>&1 | tee drift_output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for Drift
        if: steps.should-run.outputs.run == 'true'
        id: drift
        run: |
          # Exit codes: 0 = no changes, 1 = error, 2 = changes detected
          if [ "${{ steps.plan.outputs.exit_code }}" == "2" ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "::warning::Infrastructure drift detected in ${{ matrix.environment }} environment!"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "No drift detected in ${{ matrix.environment }} environment."
          fi

      - name: Create Issue for Drift
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const driftOutput = fs.readFileSync('drift_output.txt', 'utf8');
            const truncated = driftOutput.length > 60000 ? driftOutput.substring(0, 60000) + '\n...(truncated)' : driftOutput;
            
            // Check for existing open drift issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'infrastructure-drift,${{ matrix.environment }}'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Infrastructure Drift Detected - ${{ matrix.environment }}`,
                labels: ['infrastructure-drift', '${{ matrix.environment }}', 'automated'],
                body: `## Infrastructure Drift Detected
                
            **Environment:** \`${{ matrix.environment }}\`
            **Detected at:** \`${{ github.event.repository.updated_at }}\`
            **Workflow Run:** [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### Drift Details
            
            <details>
            <summary>Terraform Plan Output</summary>
            
            \`\`\`terraform
            ${truncated}
            \`\`\`
            
            </details>
            
            ### Recommended Actions
            
            1. Review the drift and determine if it was intentional
            2. If intentional, update the Terraform code to match
            3. If unintentional, run Terraform apply to remediate
            4. Close this issue once resolved
            
            ---
            *This issue was automatically created by the drift detection workflow.*`
              });
            } else {
              // Update existing issue with new drift info
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Drift Still Detected
                
            **Detected at:** \`${{ github.event.repository.updated_at }}\`
            
            <details>
            <summary>Latest Terraform Plan Output</summary>
            
            \`\`\`terraform
            ${truncated}
            \`\`\`
            
            </details>`
              });
            }

  # ============================================================================
  # Summary Report
  # ============================================================================
  summary:
    name: "Drift Summary"
    runs-on: ubuntu-latest
    needs: [drift-detection]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“Š Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dev | ${{ needs.drift-detection.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.drift-detection.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prod | ${{ needs.drift-detection.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Run completed at: $(date)*" >> $GITHUB_STEP_SUMMARY
