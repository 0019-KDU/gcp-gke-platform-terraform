# ============================================================================
# Terraform Deploy Pipeline - Manual deployment only
# ============================================================================
name: "Terraform Deploy"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: "Terraform action"
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      auto_approve:
        description: "Auto approve apply/destroy (use with caution)"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

env:
  TF_VERSION: "1.9.0"
  TF_LOG: "INFO"

# Ensure only one deployment at a time per environment
concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Deploy Infrastructure
  # ============================================================================
  deploy:
    name: "Deploy to ${{ github.event.inputs.environment }}"
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    env:
      TF_VAR_environment: ${{ github.event.inputs.environment }}
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="prefix=gke-platform/${{ github.event.inputs.environment }}"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        run: terraform validate

      # Plan for apply action
      - name: Terraform Plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        id: plan
        run: |
          terraform plan \
            -out=tfplan \
            -input=false

      # Plan for destroy action
      - name: Terraform Plan Destroy
        if: github.event.inputs.action == 'destroy'
        id: plan-destroy
        run: |
          terraform plan \
            -destroy \
            -out=tfplan \
            -input=false

      # Apply (only if auto_approve is true or action is plan-only will skip)
      - name: Terraform Apply
        if: github.event.inputs.action == 'apply' && github.event.inputs.auto_approve == 'true'
        run: terraform apply -auto-approve tfplan

      # Apply with manual approval message
      - name: Manual Approval Required
        if: github.event.inputs.action == 'apply' && github.event.inputs.auto_approve == 'false'
        run: |
          echo "::warning::Auto-approve is disabled. Review the plan above and re-run with auto_approve=true to apply changes."
          echo "Plan file saved. Re-run workflow with auto_approve=true to apply."

      # Destroy (only if auto_approve is true)
      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy' && github.event.inputs.auto_approve == 'true'
        run: terraform apply -auto-approve tfplan

      # Destroy with manual approval message
      - name: Manual Approval Required for Destroy
        if: github.event.inputs.action == 'destroy' && github.event.inputs.auto_approve == 'false'
        run: |
          echo "::warning::Auto-approve is disabled. Review the destroy plan above and re-run with auto_approve=true to destroy."
          echo "Destroy plan file saved. Re-run workflow with auto_approve=true to destroy."

      - name: Show Outputs
        if: github.event.inputs.action == 'apply' && github.event.inputs.auto_approve == 'true'
        run: terraform output
        continue-on-error: true

  # ============================================================================
  # Post-Deployment Notification
  # ============================================================================
  notify:
    name: "Notify"
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && !cancelled()
    steps:
      - name: Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Terraform Deployment Complete",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Terraform Deployment*\n• Environment: `${{ github.event.inputs.environment }}`\n• Action: `${{ github.event.inputs.action }}`\n• Auto Approve: `${{ github.event.inputs.auto_approve }}`\n• Status: `${{ needs.deploy.result }}`\n• Actor: `${{ github.actor }}`\n• <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true
